<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Token Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script>
    <style>
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Token Exploiter</h1>
        <div id="rateLimitInfo" class="alert alert-info text-center" style="display: none;">
            <strong>API Rate Limit:</strong> <span id="rateLimitRemaining"></span> / <span id="rateLimitLimit"></span> 
            (Resets at <span id="rateLimitReset"></span>)
        </div>
        <div class="row justify-content-center">
            <div class="col-md-6">
                <form id="tokenForm">
                    <div class="mb-3">
                        <label for="token" class="form-label">GitHub Personal Access Token</label>
                        <input type="text" class="form-control" id="token" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Analyze</button>
                </form>
            </div>
        </div>
        <div id="progress" class="mt-3" style="display: none;">
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <p id="currentStep" class="text-center mt-2"></p>
        </div>
        <div id="results" class="mt-5" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">User Info</h5>
                            <div id="userInfoCard"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Token Permissions</h5>
                            <div id="permissionsCard"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Quick Stats</h5>
                            <div id="statsCard"></div>
                        </div>
                    </div>
                </div>
            </div>
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="repos-tab" data-bs-toggle="tab" data-bs-target="#repos" type="button" role="tab" aria-controls="repos" aria-selected="true">Repositories</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="orgs-tab" data-bs-toggle="tab" data-bs-target="#orgs" type="button" role="tab" aria-controls="orgs" aria-selected="false">Organizations</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gists-tab" data-bs-toggle="tab" data-bs-target="#gists" type="button" role="tab" aria-controls="gists" aria-selected="false">Gists</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ssh-keys-tab" data-bs-toggle="tab" data-bs-target="#ssh-keys" type="button" role="tab" aria-controls="ssh-keys" aria-selected="false">SSH Keys</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="emails-tab" data-bs-toggle="tab" data-bs-target="#emails" type="button" role="tab" aria-controls="emails" aria-selected="false">Emails</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="followers-tab" data-bs-toggle="tab" data-bs-target="#followers" type="button" role="tab" aria-controls="followers" aria-selected="false">Followers</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="following-tab" data-bs-toggle="tab" data-bs-target="#following" type="button" role="tab" aria-controls="following" aria-selected="false">Following</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="webhooks-tab" data-bs-toggle="tab" data-bs-target="#webhooks" type="button" role="tab" aria-controls="webhooks" aria-selected="false">Webhooks</button>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="repos" role="tabpanel" aria-labelledby="repos-tab"></div>
                <div class="tab-pane fade" id="orgs" role="tabpanel" aria-labelledby="orgs-tab"></div>
                <div class="tab-pane fade" id="gists" role="tabpanel" aria-labelledby="gists-tab"></div>
                <div class="tab-pane fade" id="ssh-keys" role="tabpanel" aria-labelledby="ssh-keys-tab"></div>
                <div class="tab-pane fade" id="emails" role="tabpanel" aria-labelledby="emails-tab"></div>
                <div class="tab-pane fade" id="followers" role="tabpanel" aria-labelledby="followers-tab"></div>
                <div class="tab-pane fade" id="following" role="tabpanel" aria-labelledby="following-tab"></div>
                <div class="tab-pane fade" id="webhooks" role="tabpanel" aria-labelledby="webhooks-tab"></div>
            </div>
            <button id="exportPdf" class="btn btn-success mt-3">Export to PDF</button>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            var socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('progress_update', function(data) {
                updateProgress(data.progress, data.step, data.sub_step);
            });

            socket.on('analysis_complete', function(data) {
                displayResults(data);
            });

            $('#tokenForm').submit(function(e) {
                e.preventDefault();
                $('#progress').show();
                updateProgress(0, 'Starting analysis...');
                socket.emit('analyze_token', {token: $('#token').val()});
            });

            $('#exportPdf').click(function() {
                var dataToExport = window.githubData;
                dataToExport.token = $('#token').val();
                $.ajax({
                    url: '/export_pdf',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(dataToExport),
                    success: function(response) {
                        var blob = new Blob([response], { type: 'application/pdf' });
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = "github_info.pdf";
                        link.click();
                    }
                });
            });
        });

        function updateProgress(percentage, step, subStep) {
            percentage = Math.min(100, Math.max(0, percentage)); // Ensure percentage is between 0 and 100
            $('.progress-bar').css('width', percentage + '%').attr('aria-valuenow', percentage).text(percentage + '%');
            if (subStep) {
                $('#currentStep').html(step + '<br>' + subStep);
            } else {
                $('#currentStep').text(step);
            }
        }

        function displayResults(data) {
            window.githubData = data;
            $('#results').show();
            updateProgress(100, 'Analysis complete');

            displayRateLimit(data.rate_limit.core);

            displayUserInfo(data.user_info);
            displayPermissions(data.permissions);
            displayQuickStats(data);
            displayRepositories(data.repos);
            displayOrganizations(data.orgs);
            displayGists(data.gists);
            displaySSHKeys(data.ssh_keys);
            displayEmails(data.emails);
            displayFollowers(data.followers);
            displayFollowing(data.following);
            displayWebhooks(data.webhooks);
        }

        function displayRateLimit(rateLimit) {
            $('#rateLimitInfo').show();
            $('#rateLimitRemaining').text(rateLimit.remaining);
            $('#rateLimitLimit').text(rateLimit.limit);
            const resetDate = new Date(rateLimit.reset * 1000).toLocaleString();
            $('#rateLimitReset').text(resetDate);
        }

        function displayUserInfo(userInfo) {
            let content = `
                <p><strong>Username:</strong> ${userInfo.login}</p>
                <p><strong>Name:</strong> ${userInfo.name || 'N/A'}</p>
                <p><strong>Email:</strong> ${userInfo.email || 'N/A'}</p>
                <p><strong>Location:</strong> ${userInfo.location || 'N/A'}</p>
                <p><strong>Public Repos:</strong> ${userInfo.public_repos}</p>
                <p><strong>Private Repos:</strong> ${userInfo.total_private_repos || 'N/A'}</p>
            `;
            $('#userInfoCard').html(content);
        }

        function displayPermissions(permissions) {
            let content = '<ul class="list-group">';
            permissions.forEach(perm => {
                content += `<li class="list-group-item list-group-item-info">${perm}</li>`;
            });
            content += '</ul>';
            $('#permissionsCard').html(content);
        }

        function displayQuickStats(data) {
            let content = `
                <p><strong>Repositories:</strong> ${data.repos.length}</p>
                <p><strong>Organizations:</strong> ${data.orgs.length}</p>
                <p><strong>Gists:</strong> ${data.gists.length}</p>
                <p><strong>SSH Keys:</strong> ${data.ssh_keys.length}</p>
                <p><strong>Followers:</strong> ${data.followers.length}</p>
                <p><strong>Following:</strong> ${data.following.length}</p>
            `;
            $('#statsCard').html(content);
        }

        function displayRepositories(repos) {
            const token = $('#token').val();
            let content = '';

            // Ajout du bouton pour copier toutes les commandes en haut
            const allCommands = repos.map(repo => `git clone https://${token}@github.com/${repo.full_name}.git`).join('\n');
            content += `
            <div class="mb-3">
                <button class="btn btn-primary copy-all-btn" data-clipboard-text="${allCommands}">
                    Copy All Clone Commands
                </button>
            </div>
            `;

            content += '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Name</th><th>Description</th><th>Private</th><th>Clone Command</th></tr></thead><tbody>';
            repos.forEach(repo => {
                const cloneCommand = `git clone https://${token}@github.com/${repo.full_name}.git`;
                content += `
                <tr>
                    <td>${repo.name}</td>
                    <td>${repo.description || 'N/A'}</td>
                    <td>${repo.private ? 'Yes' : 'No'}</td>
                    <td>
                        <div class="input-group">
                            <input type="text" class="form-control" value="${cloneCommand}" readonly>
                            <button class="btn btn-outline-secondary copy-btn" type="button" data-clipboard-text="${cloneCommand}">Copy</button>
                        </div>
                    </td>
                </tr>
                `;
            });
            content += '</tbody></table></div>';

            $('#repos').html(content);

            // Initialiser Clipboard.js
            new ClipboardJS('.copy-btn');
            new ClipboardJS('.copy-all-btn');

            // Ajouter des tooltips pour le feedback de copie
            $('.copy-btn, .copy-all-btn').tooltip({
                trigger: 'click',
                placement: 'top'
            });

            // Gérer le feedback de copie
            $('.copy-btn, .copy-all-btn').on('click', function () {
                $(this).tooltip('hide')
                    .attr('data-original-title', 'Copied!')
                    .tooltip('show');

                setTimeout(() => {
                    $(this).tooltip('hide');
                }, 1000);
            });
        }

        function displayOrganizations(orgs) {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Name</th><th>Description</th><th>URL</th></tr></thead><tbody>';
            if (orgs.length === 0) {
                content += '<tr><td colspan="3" class="text-center">No organizations found</td></tr>';
            } else {
                orgs.forEach(org => {
                    content += `
                    <tr>
                        <td>${org.login}</td>
                        <td>${org.description || 'N/A'}</td>
                        <td><a href="${org.url}" target="_blank">${org.url}</a></td>
                    </tr>
                `;
                });
            }
            content += '</tbody></table></div>';
            $('#orgs').html(content);
        }

        function displayGists(gists) {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Description</th><th>URL</th></tr></thead><tbody>';
            if (gists.length === 0) {
                content += '<tr><td colspan="2" class="text-center">No gists found</td></tr>';
            } else {
                gists.forEach(gist => {
                    content += `
                    <tr>
                        <td>${gist.description || 'N/A'}</td>
                        <td><a href="${gist.html_url}" target="_blank">${gist.html_url}</a></td>
                    </tr>
                `;
                });
            }
            content += '</tbody></table></div>';
            $('#gists').html(content);
        }

        function displaySSHKeys(sshKeys) {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Title</th><th>Key</th></tr></thead><tbody>';
            if (sshKeys.length === 0) {
                content += '<tr><td colspan="2" class="text-center">No SSH keys found</td></tr>';
            } else {
                sshKeys.forEach(key => {
                    content += `
                    <tr>
                        <td>${key.title}</td>
                        <td><code>${key.key.substring(0, 30)}...</code></td>
                    </tr>
                `;
                });
            }
            content += '</tbody></table></div>';
            $('#ssh-keys').html(content);
        }

        function displayEmails(emails) {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Email</th><th>Primary</th></tr></thead><tbody>';
            if (emails.length === 0) {
                content += '<tr><td colspan="2" class="text-center">No emails found</td></tr>';
            } else {
                emails.forEach(email => {
                    content += `
                    <tr>
                        <td>${email.email}</td>
                        <td>${email.primary ? '<span class="badge bg-primary">Primary</span>' : ''}</td>
                    </tr>
                `;
                });
            }
            content += '</tbody></table></div>';
            $('#emails').html(content);
        }

        function displayFollowers(followers) {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Username</th><th>URL</th></tr></thead><tbody>';
            if (followers.length === 0) {
                content += '<tr><td colspan="2" class="text-center">No followers found</td></tr>';
            } else {
                followers.forEach(follower => {
                    content += `
                    <tr>
                        <td>${follower.login}</td>
                        <td><a href="${follower.html_url}" target="_blank">${follower.html_url}</a></td>
                    </tr>
                `;
                });
            }
            content += '</tbody></table></div>';
            $('#followers').html(content);
        }

        function displayFollowing(following) {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Username</th><th>URL</th></tr></thead><tbody>';
            if (following.length === 0) {
                content += '<tr><td colspan="2" class="text-center">No following found</td></tr>';
            } else {
                following.forEach(follow => {
                    content += `
                    <tr>
                        <td>${follow.login}</td>
                        <td><a href="${follow.html_url}" target="_blank">${follow.html_url}</a></td>
                    </tr>
                `;
                });
            }
            content += '</tbody></table></div>';
            $('#following').html(content);
        }

        function displayWebhooks(webhooks) {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Repository</th><th>URL</th><th>Events</th></tr></thead><tbody>';
            if (webhooks.length === 0) {
                content += '<tr><td colspan="3" class="text-center">No webhooks found</td></tr>';
            } else {
                webhooks.forEach(repoWebhook => {
                    repoWebhook.hooks.forEach(hook => {
                        content += `
                        <tr>
                            <td>${repoWebhook.repo}</td>
                            <td>${hook.config.url || 'N/A'}</td>
                            <td>${hook.events.join(', ')}</td>
                        </tr>
                        `;
                    });
                });
            }
            content += '</tbody></table></div>';
            $('#webhooks').html(content);
        }
    </script>
</body>
</html>